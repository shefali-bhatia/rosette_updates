#lang rosette 
 
(require "../cosette.rkt" "../sql.rkt" "../evaluator.rkt" "../syntax.rkt") 
 
(provide ros-instance)
 
(current-bitwidth #f)
(define indiv_sample_nyc-info (table-info "indiv_sample_nyc" (list "cmte_id" "transaction_amt" "name")))
(define comm-info (table-info "comm" (list "cmte_id" "cmte_nm" "cand_id")))
(define cand-info (table-info "cand" (list "cand_name" "cand_id")))
(define all-tables (list indiv_sample_nyc-info comm-info cand-info))
(define (q1 tables)
(SELECT (VALS "t2.cmte_id" (SUM "t2.transaction_amt") (COUNT "t2.cmte_id") "t2.cmte_nm")
                         FROM (AS (SELECT (VALS "t.cmte_id" "t.cmte_nm" "t.cand_id" "t.cmte_id_2" "t.transaction_amt" "t.name")
                                   FROM (AS (JOIN (NAMED (list-ref tables 0)) (NAMED (list-ref tables 1)))
                                        ["t" (list "cmte_id" "transaction_amt" "name" "cmte_id_2" "cmte_nm" "cand_id")])
                                   WHERE (BINOP "t.cmte_id" = "t.cmte_id_2"))
                                ["t2" (list "cmte_id" "cmte_nm" "cand_id" "cmte_id_2" "transaction_amt" "name")])
                         WHERE (AND (TRUE) (AND (TRUE) (TRUE)))
                         GROUP-BY (list "t2.cmte_id") 
                         HAVING (TRUE)))
(define (q2 tables)
(AS (SELECT (VALS "t_2.cmte_id" (SUM "t_2.transaction_amt") (COUNT "t_2.cmte_id") "t_2.cmte_nm")
FROM (AS (SELECT (VALS "t.cmte_id" "t.transaction_amt" "t.name" "t.cmte_id_2" "t.cmte_nm" "t.cand_id")
FROM (AS (JOIN (AS (NAMED (list-ref tables 0))
["indiv_sample_nyc" (list "cmte_id" "transaction_amt" "name")]) (AS (NAMED (list-ref tables 1))
["comm" (list "cmte_id" "cmte_nm" "cand_id")]) )
["t" (list "cmte_id" "transaction_amt" "name" "cmte_id_2" "cmte_nm" "cand_id")])
WHERE (BINOP "t.cmte_id" = "t.cmte_id_2")  )
["t_2" (list "cmte_id" "transaction_amt" "name" "cmte_id_2" "cmte_nm" "cand_id")])
WHERE (AND (AND (TRUE) (TRUE)) (TRUE)) 
GROUP-BY (list "t_2.cmte_id" ) 
HAVING (TRUE))
["t_3" (list "cmte_id" "total_amount" "num_donations" "cmte_nm")]))
(define ros-instance (list q1 q2 all-tables))